---
name: "Release"
description: "Build, sign, and publish a new Speex release with auto-update support"
alwaysAllow: ["Bash", "Read", "Edit", "Write", "Grep", "Glob"]
---

# Release Speex

Automated release workflow. Executes ALL steps sequentially without asking for confirmation.

## Pre-flight Checks

1. Verify working tree is clean (`git status`). If there are uncommitted changes, abort and tell the user.
2. Read current version from `project.yml` (`MARKETING_VERSION`) and `CURRENT_PROJECT_VERSION`.
3. Ask the user what the new version should be (patch, minor, or explicit), or accept it as an argument (e.g., `/release 0.0.3`).

## Version Bump

4. Update `MARKETING_VERSION` in `project.yml` to the new version.
5. Increment `CURRENT_PROJECT_VERSION` by 1 in `project.yml`.
6. Run `xcodegen generate` to regenerate the Xcode project.
7. Verify `project.pbxproj` has the updated version.

## Build, Sign & Upload

8. Run `bash scripts/build-dmg.sh` and capture the output.
   - This builds Release, creates DMG, signs with EdDSA, generates `appcast.xml`, and uploads both to Firebase Storage.
   - Timeout: 10 minutes.
9. Verify `dist/Speex-{version}.dmg` and `dist/appcast.xml` exist.
10. Verify the appcast XML contains the correct version, Firebase Storage URL, and EdDSA signature.

## Commit & Tag

11. Stage all changes: `project.yml`, `Speex.xcodeproj/project.pbxproj`
12. Commit with message:
    ```
    release: v{version}

    Co-Authored-By: Craft Agent <agents-noreply@craft.do>
    ```
13. Create a git tag: `git tag v{version}`

## Publish

14. Push commit and tag: `git push && git push --tags`

## Post-release Summary

15. Print a summary:
    - Version: old → new
    - DMG size
    - Firebase Storage DMG URL
    - Firebase Storage Appcast URL
    - Remind: "Users with Speex installed will receive the update automatically via Sparkle."

## Important Notes

- NEVER skip the EdDSA signing step — without it, Sparkle won't accept the update.
- The EdDSA private key is in the macOS Keychain (generated by Sparkle's `generate_keys`).
- The appcast is hosted on Firebase Storage at: `https://firebasestorage.googleapis.com/v0/b/whisper-f6336.firebasestorage.app/o/releases%2Fappcast.xml?alt=media`
- DMG download URL pattern: `https://firebasestorage.googleapis.com/v0/b/whisper-f6336.firebasestorage.app/o/releases%2FSpeex-{version}.dmg?alt=media`
- The `build-dmg.sh` script handles the upload to Firebase Storage automatically.
- Use `--no-gpg-sign` for git commit if GPG signing fails.
- Use `DEVELOPER_DIR=/Applications/Xcode.app/Contents/Developer` for xcodebuild commands.
